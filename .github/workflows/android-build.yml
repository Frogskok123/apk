name: Android Build & Compile

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-levels: 34
          build-tools-version: 34.0.0
      
      - name: Accept Android licenses
        run: |
          yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses || true
          yes | $ANDROID_HOME/tools/bin/sdkmanager --update || true
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Full System Clean
        run: |
          echo "=== Performing full system clean ==="
          ./gradlew clean --no-daemon
          ./gradlew cleanBuildCache --no-daemon
          find . -type d -name "build" -exec rm -rf {} + 2>/dev/null || true
          find . -type d -name ".gradle" -exec rm -rf {} + 2>/dev/null || true
          rm -rf app/src/main/jniLibs/
          rm -rf .gradle/
          echo "=== Gradle cache cleared ==="
      
      - name: Build APK (Debug)
        run: |
          echo "Starting Gradle build..."
          ./gradlew clean assembleDebug --info --no-daemon --refresh-dependencies -x lint 2>&1 | tee build.log
        continue-on-error: false
      
      - name: Check build outputs
        run: |
          echo "=== APK Outputs ==="
          ls -lah app/build/outputs/apk/debug/ 2>/dev/null || echo "Debug APK not found"
          echo ""
          echo "=== Libraries ==="
          find app/build -name "*.so" -type f 2>/dev/null || echo "No SO files found"
          echo ""
          echo "=== Build Directory ==="
          ls -lah app/build/ 2>/dev/null || echo "Build directory not found"
      
      - name: Upload debug APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7
      
      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log
          retention-days: 7

  ndk-build:
    name: Build NDK Native Libraries
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r25c
          add-to-path: true
      
      - name: Build with ndk-build
        run: |
          cd app/src/main/jni
          echo "=== NDK Info ==="
          ndk-build --version
          echo "NDK_ROOT: $ANDROID_NDK_ROOT"
          echo ""
          echo "=== Building native libraries ==="
          ndk-build clean
          ndk-build -j$(nproc) V=1 2>&1 | tee ndk_build.log
      
      - name: Check compiled libraries
        run: |
          echo "=== Compiled Libraries ==="
          find app/src/main/jniLibs -name "*.so" -type f 2>/dev/null | head -20 || echo "No SO files found"
          echo ""
          echo "=== ARM64-V8A Libraries ==="
          file app/src/main/jniLibs/arm64-v8a/*.so 2>/dev/null || echo "No ARM64 libraries"
          echo ""
          echo "=== ARMV7A Libraries ==="
          file app/src/main/jniLibs/armeabi-v7a/*.so 2>/dev/null || echo "No ARMv7 libraries"
      
      - name: Upload native libraries
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: native-libraries
          path: app/src/main/jniLibs/
          retention-days: 7
      
      - name: Upload NDK build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ndk-build-log
          path: app/src/main/jni/ndk_build.log
          retention-days: 7

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Run lint checks
        run: |
          echo "Running lint checks..."
          ./gradlew lint --info --no-daemon 2>&1 | tee lint.log || true
        continue-on-error: true
      
      - name: Check results
        run: |
          echo "Lint checks completed"
          if [ -f "app/build/reports/lint-results.html" ]; then
            echo "Lint report generated"
          fi
        continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for hardcoded credentials
        run: |
          echo "Scanning for hardcoded credentials..."
          grep -r "apiKey\|password\|token\|secret" --include="*.java" --include="*.cpp" --include="*.gradle" app/ 2>/dev/null || echo "No obvious credentials found"
          echo "Security scan completed"
        continue-on-error: true
      
      - name: Check for dangerous permissions
        run: |
          echo "Checking for dangerous permissions..."
          grep -r "WRITE_EXTERNAL_STORAGE\|READ_EXTERNAL_STORAGE\|SYSTEM_ALERT_WINDOW" app/src/main/AndroidManifest.xml 2>/dev/null || echo "Standard permissions only"
        continue-on-error: true