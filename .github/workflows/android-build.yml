name: Android Build & Compile

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    name: Build APK
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: gradle
      
      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r21e
          add-to-path: true
      
      - name: Set up Android SDK
        uses: android-actions/setup-android@v3
        with:
          api-levels: 30
          build-tools-version: 30.0.3
      
      - name: Accept Android licenses
        run: |
          yes | $ANDROID_HOME/tools/bin/sdkmanager --licenses || true
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Build APK (Debug)
        run: ./gradlew assembleDebug --info -x lint
        continue-on-error: false
      
      - name: Check build outputs
        run: |
          echo "=== APK Outputs ==="
          ls -lah app/build/outputs/apk/debug/ 2>/dev/null || echo "Debug APK not found"
          echo ""
          echo "=== Libraries ==="
          find app/build -name "*.so" -type f 2>/dev/null || echo "No SO files found"
      
      - name: Upload debug APK
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: apk-debug
          path: app/build/outputs/apk/debug/app-debug.apk
          retention-days: 7
      
      - name: Generate build report
        if: always()
        run: |
          echo "# Build Report" > build_report.md
          echo "" >> build_report.md
          echo "## Build Status" >> build_report.md
          echo "- Date: $(date)" >> build_report.md
          echo "- Branch: ${{ github.ref }}" >> build_report.md
          echo "- Commit: ${{ github.sha }}" >> build_report.md
          echo "" >> build_report.md
          echo "## Build Info" >> build_report.md
          if [ -f "app/build/outputs/apk/debug/app-debug.apk" ]; then
            echo "- Debug APK: ✅ Built" >> build_report.md
            echo "- Size: $(du -h app/build/outputs/apk/debug/app-debug.apk | cut -f1)" >> build_report.md
          else
            echo "- Debug APK: ⚠️ Check logs" >> build_report.md
          fi
      
      - name: Upload build report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build_report.md
          retention-days: 7

  ndk-build:
    name: Build NDK Native Libraries
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Android NDK
        uses: nttld/setup-ndk@v1
        with:
          ndk-version: r21e
          add-to-path: true
      
      - name: Build with ndk-build
        run: |
          cd app/src/main/jni
          echo "NDK version:"
          ndk-build --version
          echo ""
          echo "Building native libraries..."
          ndk-build clean
          ndk-build -j$(nproc) V=1
      
      - name: Check compiled libraries
        run: |
          echo "=== Compiled Libraries ==="
          find app/src/main/jniLibs -name "*.so" -type f 2>/dev/null | head -20 || echo "No SO files found"
          echo ""
          echo "=== ARM64-V8A Libraries ==="
          file app/src/main/jniLibs/arm64-v8a/*.so 2>/dev/null || echo "No ARM64 libraries"
          echo ""
          echo "=== ARMV7A Libraries ==="
          file app/src/main/jniLibs/armeabi-v7a/*.so 2>/dev/null || echo "No ARMv7 libraries"
      
      - name: Upload native libraries
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: native-libraries
          path: app/src/main/jniLibs/
          retention-days: 7

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
      
      - name: Make gradlew executable
        run: chmod +x ./gradlew
      
      - name: Run lint checks
        run: ./gradlew lint --info -x assembleDebug 2>/dev/null || echo "Lint checks completed"
        continue-on-error: true
      
      - name: Check for code issues
        run: |
          echo "Code quality checks completed"
          echo "Check build/reports/ for detailed analysis"
        continue-on-error: true

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Check for hardcoded credentials
        run: |
          echo "Scanning for hardcoded credentials..."
          grep -r "apiKey\|password\|token" --include="*.java" --include="*.cpp" --include="*.gradle" app/ 2>/dev/null || echo "No obvious credentials found"
          echo "Security scan completed"
        continue-on-error: true
